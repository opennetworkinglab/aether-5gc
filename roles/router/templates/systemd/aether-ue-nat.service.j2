# Copyright 2022-present Open Networking Foundation
# SPDX-License-Identifier: Apache-2.0

[Unit]
Description=Aether UE NAT Setup
After=network.target

[Service]
Type=oneshot
ExecStart=/bin/bash -c "\
    sudo iptables -t nat -C POSTROUTING -s {{ core.upf.default_upf.ue_ip_pool }} -o {{ core.data_iface }} -j MASQUERADE || \
    sudo iptables -t nat -A POSTROUTING -s {{ core.upf.default_upf.ue_ip_pool }} -o {{ core.data_iface }} -j MASQUERADE; \
    {% if '1' in core.upf.additional_upfs %} \
    sudo iptables -t nat -C POSTROUTING -s {{ core.upf.additional_upfs['1'].ue_ip_pool }} -o {{ core.data_iface }} -j MASQUERADE || \
    sudo iptables -t nat -A POSTROUTING -s {{ core.upf.additional_upfs['1'].ue_ip_pool }} -o {{ core.data_iface }} -j MASQUERADE; \
    {% endif %} \
    {% if '2' in core.upf.additional_upfs %} \
    sudo iptables -t nat -C POSTROUTING -s {{ core.upf.additional_upfs['2'].ue_ip_pool }} -o {{ core.data_iface }} -j MASQUERADE || \
    sudo iptables -t nat -A POSTROUTING -s {{ core.upf.additional_upfs['2'].ue_ip_pool }} -o {{ core.data_iface }} -j MASQUERADE; \
    {% endif %} \
"

[Install]
WantedBy=multi-user.target
